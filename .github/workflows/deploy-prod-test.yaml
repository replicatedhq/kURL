name: deploy-production-debug-test

on:
  push:
    branches:
    - rafaelpolanco/sc-66950/fix-waiting-for-pending-jobs

jobs:
  build-stage-packages-matrix:
    runs-on: ubuntu-22.04
    outputs:
      package: ${{ steps.set-matrix.outputs.package }}
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Build Package Matrix
      id: set-matrix
      run: |
        export LIST_FROM_STAGE_S3="1"
        BATCH_S3_PACKAGES=$(./bin/list-all-packages-actions-matrix.sh)
        echo "${BATCH_S3_PACKAGES}" | jq
        echo "package=${BATCH_S3_PACKAGES}" >> $GITHUB_OUTPUT
      env:
        S3_BUCKET: kurl-sh
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_PROD_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_PROD_SECRET_ACCESS_KEY }}
        AWS_REGION: "us-east-1"
        STAGING_PREFIX: "staging"
        STAGING_RELEASE: "v2023.01.23-0-1a4249df"

  copy-stage-packages-to-prod:
    runs-on: ubuntu-22.04
    needs:
     - build-stage-packages-matrix
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Copy packages to Prod
      run: |
        echo "${{ needs.build-stage-packages-matrix.outputs.package }}"
      env:
        S3_BUCKET: kurl-sh
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_PROD_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_PROD_SECRET_ACCESS_KEY }}
        AWS_REGION: "us-east-1"
        PACKAGE_PREFIX: "dist"
        STAGING_PREFIX: "staging"
        STAGING_RELEASE: "v2023.01.23-0-1a4249df"
