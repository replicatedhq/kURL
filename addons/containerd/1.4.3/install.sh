
function containerd_install() {
    local src="$DIR/addons/containerd/$CONTAINERD_VERSION"

    if [ "$SKIP_CONTAINERD_INSTALL" != "1" ]; then
        install_host_packages "$src"
        containerd_configure
    fi

    containerd_configure_ctl "$src"

    # NOTE: this will not remove the proxy
    if [ -n "$PROXY_ADDRESS" ]; then
        containerd_configure_proxy
    fi

    if [ -n "$DOCKER_REGISTRY_IP" ]; then
        containerd_configure_registry "$DOCKER_REGISTRY_IP"
        if [ "$CONTAINERD_REGISTRY_CA_ADDED" = "1" ]; then
            restart_containerd
        fi
    fi

    load_images $src/images
}

function containerd_configure() {
    mkdir -p /etc/containerd
    containerd config default > /etc/containerd/config.toml

    sed -i '/systemd_cgroup/d' /etc/containerd/config.toml
    sed -i '/containerd.runtimes.runc.options/d' /etc/containerd/config.toml
    cat >> /etc/containerd/config.toml <<EOF
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
  SystemdCgroup = true
EOF

    # Always set for joining nodes since it's passed as a flag in the generated join script, but not
    # usually set for the initial install. For initial installs the registry will be configured from
    # containerd_registry_init.
    if [ -n "$DOCKER_REGISTRY_IP" ]; then
        containerd_configure_registry "$DOCKER_REGISTRY_IP"
    fi
    systemctl restart containerd
}

function containerd_configure_ctl() {
    local src="$1"

    if [ -e "/etc/crictl.yaml" ]; then
        return 0
    fi

    cp "$src/crictl.yaml" /etc/crictl.yaml
}

function containerd_registry_init() {
    if [ -z "$REGISTRY_VERSION" ]; then
        return 0
    fi

    local registryIP=$(kubectl -n kurl get service registry -o=jsonpath='{@.spec.clusterIP}' 2>/dev/null || true)
    if [ -z "$registryIP" ]; then
        kubectl -n kurl create service clusterip registry --tcp=443:443
        registryIP=$(kubectl -n kurl get service registry -o=jsonpath='{@.spec.clusterIP}')
    fi

    containerd_configure_registry "$registryIP"
    systemctl restart containerd
}

CONTAINERD_REGISTRY_CA_ADDED=0
function containerd_configure_registry() {
    local registryIP="$1"

    if grep -q "plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"${registryIP}\".tls" /etc/containerd/config.toml; then
        echo "Registry ${registryIP} TLS already configured for containerd"
        return 0
    fi

    cat >> /etc/containerd/config.toml <<EOF
[plugins."io.containerd.grpc.v1.cri".registry.configs."${registryIP}".tls]
  ca_file = "/etc/kubernetes/pki/ca.crt"
EOF

    CONTAINERD_REGISTRY_CA_ADDED=1
}

containerd_configure_proxy() {
    local previous_proxy="$(cat /etc/systemd/system/containerd.service.d/http-proxy.conf 2>/dev/null | grep -io 'https*_proxy=[^\" ]*' | awk 'BEGIN { FS="=" }; { print $2 }')"
    local previous_no_proxy="$(cat /etc/systemd/system/containerd.service.d/http-proxy.conf 2>/dev/null | grep -io 'no_proxy=[^\" ]*' | awk 'BEGIN { FS="=" }; { print $2 }')"
    if [ "$PROXY_ADDRESS" = "$previous_proxy" ] && [ "$NO_PROXY_ADDRESSES" = "$previous_no_proxy" ]; then
        return
    fi

    mkdir -p /etc/systemd/system/containerd.service.d
    local file=/etc/systemd/system/containerd.service.d/http-proxy.conf

    echo "# Generated by kURL" > $file
    echo "[Service]" >> $file

    if echo "$PROXY_ADDRESS" | grep -q "^https"; then
        echo "Environment=\"HTTPS_PROXY=${PROXY_ADDRESS}\" \"NO_PROXY=${NO_PROXY_ADDRESSES}\"" >> $file
    else
        echo "Environment=\"HTTP_PROXY=${PROXY_ADDRESS}\" \"NO_PROXY=${NO_PROXY_ADDRESSES}\"" >> $file
    fi

    restart_containerd
}

function restart_containerd() {
    systemctl daemon-reload
    systemctl restart containerd
}
