- name: k8s119_containerd149
  installerSpec:
    kubernetes:
      version: 1.19.x
    weave:
      version: 2.6.4
    contour:
      version: 1.0.1
    rook:
      version: 1.0.4
    registry:
      version: 2.7.1
    prometheus:
      version: "0.53.x"
    kotsadm:
      version: latest
    velero:
      version: 1.2.0
    ekco:
      version: 0.6.0
    containerd:
      version: 1.4.9
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not available on ubuntu 22.04
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variant4
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s121x_containerd
  installerSpec:
    kubernetes:
      version: 1.21.x
      containerLogMaxSize: "5Mi"
      containerLogMaxFiles: 5
    containerd:
      version: 1.4.6
    weave:
      version: 2.6.5
    contour:
      version: 1.0.1
    longhorn:
      version: 1.2.2
    registry:
      version: 2.7.1
    prometheus:
      version: "0.53.x"
    kotsadm:
      version: latest
    velero:
      version: 1.2.0
    minio:
      version: latest
    ekco:
      version: latest
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not available on ubuntu 22.04
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variant4
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s1184_1202_containerd
  installerSpec:
    kubernetes:
      version: 1.18.4
    weave:
      version: 2.6.5
    contour:
      version: 1.0.1
    containerd:
      version: 1.4.6
  upgradeSpec:
    kubernetes:
      version: 1.20.2
    weave:
      version: 2.6.5
    contour:
      version: 1.28.3
    containerd:
      version: 1.6.x
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variant4
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s119x_containerd148
  installerSpec:
    kubernetes:
      version: 1.19.x
    weave:
      version: 2.6.5
    contour:
      version: 1.0.1
    rook:
      version: 1.0.4
    registry:
      version: 2.7.1
    prometheus:
      version: "0.53.x"
    kotsadm:
      version: latest
    velero:
      version: 1.2.0
    ekco:
      version: 0.6.0
    containerd:
      version: 1.4.13
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variant4
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s119x_containerd139
  installerSpec:
    kubernetes:
      version: 1.19.x
    weave:
      version: 2.6.5
    contour:
      version: 1.0.1
    rook:
      version: 1.0.4
    registry:
      version: 2.7.1
    prometheus:
      version: "0.53.x"
    kotsadm:
      version: latest
    velero:
      version: 1.2.0
    ekco:
      version: 0.6.0
    containerd:
      version: 1.4.9
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variant4
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s119_containerd1412
  installerSpec:
    kubernetes:
      version: 1.19.x
    weave:
      version: 2.8.1
    contour:
      version: 1.0.1
    rook:
      version: 1.0.4
    registry:
      version: 2.7.1
    prometheus:
      version: "0.53.x"
    kotsadm:
      version: latest
    velero:
      version: 1.2.0
    ekco:
      version: 0.6.0
    containerd:
      version: 1.4.12
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variant4
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s119_containerd146-airgap
  installerSpec:
    kubernetes:
      version: 1.19.x
    weave:
      version: 2.8.1
    contour:
      version: 1.0.1
    rook:
      version: 1.0.4
    registry:
      version: 2.7.1
    prometheus:
      version: "0.53.x"
    kotsadm:
      version: latest
    velero:
      version: 1.2.0
    ekco:
      version: 0.6.0
    containerd:
      version: 1.4.6
  airgap: true
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variant4
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s119_containerd_rook_block
  cpu: 6
  installerSpec:
    kubernetes:
      version: 1.19.3
    weave:
      version: 2.6.5
    contour:
      version: 1.7.0
    rook:
      version: 1.8.x
    registry:
      version: 2.7.1
    fluentd:
      fullEFKStack: true
      version: 1.7.4
    kotsadm:
      version: 1.25.2
    ekco:
      version: latest
    containerd:
      version: 1.4.10
    certManager:
      version: 1.0.3
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variantsl
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s119_ctrd_longhorn
  installerSpec:
    kubernetes:
      version: 1.19.9
    weave:
      version: 2.8.1
    contour:
      version: 1.7.0
    registry:
      version: 2.7.1
    fluentd:
      fullEFKStack: true
      version: 1.7.4
    kotsadm:
      uiBindPort: 30880
      version: 1.25.2
    minio:
      version: latest
    ekco:
      version: 0.7.0
    containerd:
      version: 1.4.6
    certManager:
      version: 1.0.3
    longhorn:
      version: 1.1.2
      uiBindPort: 30080
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variant4
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s119_ctrd_longhorn-airgap
  installerSpec:
    kubernetes:
      version: 1.19.9
    weave:
      version: 2.8.1
    contour:
      version: 1.7.0
    registry:
      version: 2.7.1
    fluentd:
      fullEFKStack: true
      version: 1.7.4
    kotsadm:
      uiBindPort: 30880
      version: 1.25.2
    minio:
      version: latest
    ekco:
      version: 0.7.0
    containerd:
      version: 1.4.6
    certManager:
      version: 1.0.3
    longhorn:
      version: 1.3.1
      uiBindPort: 30080
  airgap: true
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variant4
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s119_helm
  installerSpec:
    kubernetes:
      version: latest
    weave:
      version: latest
    containerd:
      version: 1.4.6
    helm:
      helmfileSpec: |-
        repositories:
        - name: nginx-stable
          url: https://helm.nginx.com/stable
        releases:
        - name: nginx-ingress
          chart: nginx-stable/nginx-ingress
          version: ~0.8.0
          values:
          - controller:
              image:
                tag: 1.9.1
              service:
                type: NodePort
                httpPort:
                  nodePort: 30080
                httpsPort:
                  nodePort: 30443
  upgradeSpec:
    kubernetes:
      version: latest
    weave:
      version: latest
    containerd:
      version: 1.5.11
    helm:
      helmfileSpec: |-
        repositories:
        - name: nginx-stable
          url: https://helm.nginx.com/stable
        releases:
        - name: nginx-ingress
          chart: nginx-stable/nginx-ingress
          version: ~0.8.0
          values:
          - controller:
              image:
                tag: 1.10.0
              service:
                type: NodePort
                httpPort:
                  nodePort: 30080
                httpsPort:
                  nodePort: 30443
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variant4
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s120_minimal_containerd1411
  installerSpec:
    kubernetes:
      version: 1.20.x
    weave:
      version: 2.6.5
    contour:
      version: 1.11.0
      httpPort: 8080
      httpsPort: 8443
    containerd:
      version: 1.4.11
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variant4
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s129_selinux
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.29.x
    containerd:
      version: latest
    weave:
      version: 2.8.1
    selinuxConfig:
      selinux: permissive
      semanageCmds:
      - - user
        - -a
        - -R
        - staff_r sysadm_r system_r
        - -r
        - s0-s0:c0.c1023
        - my_staff_u
      type: targeted
- name: k8s120
  installerSpec:
    kubernetes:
      version: 1.20.x
    weave:
      version: 2.8.1
    contour:
      version: 1.13.1
    registry:
      version: 2.7.1
    prometheus:
      version: "0.53.x"
    kotsadm:
      version: latest
    velero:
      version: 1.5.3
    minio:
      version: latest
    ekco:
      version: latest
    containerd:
      version: 1.4.6
    longhorn:
      version: 1.1.2
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variant4
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s120-airgap
  installerSpec:
    kubernetes:
      version: 1.20.x
    weave:
      version: 2.8.1
    contour:
      version: 1.13.1
    registry:
      version: 2.7.1
    prometheus:
      version: "0.53.x"
    kotsadm:
      version: latest
    velero:
      version: 1.5.3
    minio:
      version: latest
    ekco:
      version: latest
    containerd:
      version: 1.4.6
    longhorn:
      version: 1.1.2
  airgap: true
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variant4
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: k8s24x_rook_upgrade_17x_110x
  flags: "yes"
  cpu: 6
  installerSpec:
    kubernetes:
      version: 1.24.x
    weave:
      version: 2.8.1
    rook:
      isBlockStorageEnabled: true
      version: 1.7.x
    kotsadm:
      version: 1.93.x
    containerd:
      version: 1.6.x
    ekco:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.30.x
    weave:
      version: 2.8.1
    rook:
      bypassUpgradeWarning: true
      version: 1.10.x
    kotsadm:
      version: latest
    containerd:
      version: 1.6.x
    ekco:
      version: latest
  unsupportedOSIDs:
    - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: remove_all_object_storage
  cpu: 7
  installerSpec:
    kubernetes:
      version: 1.23.x
    flannel:
      version: latest
    rook:
      version: 1.12.x
    registry:
      version: latest
    kotsadm:
      version: latest
    containerd:
      version: latest
    velero:
      version: 1.8.x
    ekco:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.24.x
    flannel:
      version: latest
    longhorn:
      version: latest
    registry:
      version: latest
    kotsadm:
      version: latest
      disableS3: true
    containerd:
      version: latest
    velero:
      version: 1.9.x
    ekco:
      version: latest
  unsupportedOSIDs:
  - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
  - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: "K8s 1.22x Rook"
  cpu: 6
  installerSpec:
    kubernetes:
      version: 1.22.x
    containerd:
      version: 1.6.x
    flannel:
      version: latest
    contour:
      version: 1.19.1
    rook:
      version: 1.12.x
    registry:
      version: 2.7.1
    prometheus:
      version: "0.53.x"
    kotsadm:
      version: latest
    velero:
      version: 1.7.x
    ekco:
      version: latest
  unsupportedOSIDs:
  - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
  - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: "K8s 1.22x Rook, disableS3"
  cpu: 6
  installerSpec:
    kubernetes:
      version: 1.22.x
    containerd:
      version: 1.5.x
    flannel:
      version: latest
    contour:
      version: 1.19.1
    rook:
      version: 1.12.x
    registry:
      version: 2.7.1
    kotsadm:
      version: latest
      disableS3: true
    velero:
      version: latest
    ekco:
      version: latest
  unsupportedOSIDs:
  - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variantsl
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: "K8s 1.22x Airgap"
  cpu: 6
  installerSpec:
    kubernetes:
      version: 1.22.x
    containerd:
      version: 1.6.x
    flannel:
      version: latest
    contour:
      version: 1.19.1
    rook:
      version: 1.12.x
    registry:
      version: 2.7.1
    prometheus:
      version: "0.53.x"
    kotsadm:
      version: latest
    velero:
      version: 1.9.x
    ekco:
      version: latest
  airgap: true
  preInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rhel_9_install_host_packages lvm2 conntrack-tools socat container-selinux git
  unsupportedOSIDs:
  - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
  - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: "Migrate from Docker to Containerd and Kubernetes from 1.23 to 1.30 airgap"
  flags: "yes"
  installerApiEndpoint: https://kurl.sh
  installerSpec:
    kurl:
      installerVersion: "v2024.07.02-0"
    kubernetes:
      version: 1.23.x
    weave: # flannel has errors with dns and docker
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
    ekco:
      version: latest
    registry:
      version: latest
    kotsadm:
      version: latest
    docker:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.30.x
    weave: # flannel has errors with dns and docker
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
    ekco:
      version: latest
    registry:
      version: latest
    kotsadm:
      version: latest
    containerd:
      version: latest
  airgap: true
  preInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    mkdir -p /var/lib/kurl/assets
    ( cd /var/lib/kurl/assets && curl -fLO "$(kubernetes_upgrade_bundle_url "$KURL_URL" "$KURL_UPGRADE_URL")" )
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_read_write_object_store rwtest testfile.txt
    echo "Checking kubectl with kube/config"
    echo "Kubeconfig was $KUBECONFIG"
    unset KUBECONFIG
    kubectl get namespaces
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_testfile rwtest testfile.txt
    validate_read_write_object_store postupgrade upgradefile.txt
  unsupportedOSIDs:
  - rocky-91 # doc:
  - rocky-9 # docker is not supported on rhel 9 variants
- name: "K8s 1.24x Rook"
  cpu: 6
  installerSpec:
    kubernetes:
      version: 1.24.x
    containerd:
      version: 1.4.x
    flannel:
      version: latest
    contour:
      version: 1.19.1
    rook:
      version: 1.12.x
    registry:
      version: 2.7.1
    prometheus:
      version: "0.53.x"
    kotsadm:
      version: latest
    velero:
      version: 1.7.x
    ekco:
      version: latest
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variantsl
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: "K8s 1.30x Rook, disableS3"
  cpu: 6
  installerSpec:
    kubernetes:
      version: 1.30.x
    containerd:
      version: latest
    flannel:
      version: latest
    contour:
      version: latest
    rook:
      version: 1.12.x
    registry:
      version: latest
    prometheus:
      version: latest
    kotsadm:
      version: latest
      disableS3: true
    velero:
      version: latest
    ekco:
      version: latest
      enableInternalLoadBalancer: true
  unsupportedOSIDs:
  - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
  - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: "K8s 1.24x Airgap"
  cpu: 6
  installerSpec:
    kubernetes:
      version: 1.24.x
    containerd:
      version: 1.4.x
    flannel:
      version: latest
    contour:
      version: 1.19.1
    rook:
      version: 1.12.x
    registry:
      version: 2.7.1
    prometheus:
      version: "0.53.x"
    kotsadm:
      version: latest
    velero:
      version: 1.7.x
    ekco:
      version: latest
  airgap: true
  unsupportedOSIDs:
  - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
  - rocky-91 # containerd < 1.6 is not supported on rhel 9 variantsl
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
- name: "Upgrade to 1.24, disable s3, weave to flannel"
  flags: "yes"
  cpu: 7
  installerApiEndpoint: https://kurl.sh
  installerSpec:
    kurl:
      installerVersion: "v2024.07.02-0"
    kubernetes:
      version: 1.23.x
    weave:
      version: latest
    rook:
      version: 1.12.x
    kotsadm:
      version: latest
    docker:
      version: 20.10.x
    ekco:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.24.x
    flannel:
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: local
    kotsadm:
      version: latest
      disableS3: true
    containerd:
      version: latest
    ekco:
      version: latest
  unsupportedOSIDs:
  - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
  - rocky-91 # docker is not supported on rhel 9 variantsl
  - rocky-9 # docker is not supported on rhel 9 variants
- name: "Upgrade to 1.30 minimal airgap"
  installerSpec:
    kubernetes:
      version: 1.26.x
    flannel:
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
    registry:
      version: latest
    kotsadm:
      version: latest
    containerd:
      version: latest
    ekco:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.30.x
    flannel:
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
    registry:
      version: latest
    kotsadm:
      version: latest
    containerd:
      version: latest
    ekco:
      version: latest
  airgap: true
  preInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rhel_9_install_host_packages lvm2 conntrack-tools socat container-selinux git
    mkdir -p /var/lib/kurl/assets
    ( cd /var/lib/kurl/assets && curl -fLO "$(kubernetes_upgrade_bundle_url "$KURL_URL" "$KURL_UPGRADE_URL")" )
  unsupportedOSIDs:
  - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: k8s130-all-the-flags
  installerSpec:
    kubernetes:
      version: 1.30.x
    containerd:
      version: latest
    flannel:
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
    registry:
      version: latest
    kotsadm:
      version: latest
    ekco:
      version: latest
  flags: "labels=disktype=ssd,gpu=enabled exclude-builtin-host-preflights kubernetes-max-pods-per-node=200"
  postInstallScript: |
    kubectl get node -oyaml | grep ' gpu: enabled'
    kubectl get node -oyaml | grep ' pods: "200"'
  unsupportedOSIDs:
  - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: ekco-podimageoverrides
  installerSpec:
    kubernetes:
      version: "1.30.x"
    containerd:
      version: "latest"
    flannel:
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    contour:
      version: "1.20.0"
    ekco:
      version: "latest"
      podImageOverrides:
        - ghcr.io/projectcontour/contour:v1.20.0=ghcr.io/projectcontour/contour:v1.20.1
  postInstallScript: |
    sleep 120

    pod_image="$(kubectl -n projectcontour get po -l app=contour -o jsonpath='{.items[].spec.containers[].image}')"
    if ! echo "$pod_image" | grep 'v1.20.1' ; then
      echo "Pod image override failed: $pod_image"
      exit 1
    fi

    echo "Pod image override success: $pod_image"
    
    echo "Checking kubectl with kube/config"
    echo "Kubeconfig was $KUBECONFIG"
    unset KUBECONFIG
    kubectl get namespaces
  unsupportedOSIDs:
  - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: k8s123x_124x_upgrade_cis_benchmarks_checks
  installerSpec:
    kubernetes:
      version: "1.23.x"
    containerd:
      version: "latest"
    flannel:
      version: latest
    ekco:
      version: "latest"
  upgradeSpec:
    kubernetes:
      version: "1.24.x"
      cisCompliance: true
    containerd:
      version: "latest"
    flannel:
      version: latest
    ekco:
      version: "latest"
  postUpgradeScript: |
    echo "running  CIS Kubernetes Benchmark Checks"
    curl -L https://github.com/aquasecurity/kube-bench/releases/download/v0.7.0/kube-bench_0.7.0_linux_amd64.tar.gz | tar -xz
    ./kube-bench --config-dir=`pwd`/cfg --config=`pwd`/cfg/config.yaml --exit-code=1
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: k8s130x_reserved_resources
  installerSpec:
    kubernetes:
      version: "1.30.x"
      kubeReserved: true
      evictionThresholdResources: '{"memory.available":  "234Mi", "nodefs.available": "11%", "nodefs.inodesFree": "6%"}'
      systemReservedResources: '{ "cpu": "123m", "memory": "123Mi", "ephemeral-storage": "1.23Gi" }'
    containerd:
      version: "latest"
    flannel:
      version: latest
  postInstallScript: |
    set -eo pipefail
    echo "validating kubelet config contains reserved resources"
    sudo cat /var/lib/kubelet/config.yaml | grep -A 4 kubeReserved
    sudo cat /var/lib/kubelet/config.yaml | grep "ephemeral-storage: 1Gi"
    sudo cat /var/lib/kubelet/config.yaml | grep -A 4 evictionHard
    sudo cat /var/lib/kubelet/config.yaml | grep "memory.available: 234Mi"
    sudo cat /var/lib/kubelet/config.yaml | grep -A 4 systemReserved
    sudo cat /var/lib/kubelet/config.yaml | grep "cpu: 123m"
    sudo cat /var/lib/kubelet/config.yaml | grep "ephemeral-storage: 1.23Gi"
    sudo cat /var/lib/kubelet/config.yaml | grep "memory: 123Mi"
    echo "Checking kubectl with kube/config"
    echo "Kubeconfig was $KUBECONFIG"
    unset KUBECONFIG
    kubectl get namespaces
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: less_command
  installerSpec:
    kubernetes:
      version: "1.30.x"
    containerd:
      version: latest
    flannel:
      version: latest
  postInstallScript: |
    echo "this is to test less command after installation" > test-less.txt
    less test-less.txt > /dev/null
    echo "Checking kubectl with kube/config"
    echo "Kubeconfig was $KUBECONFIG"
    unset KUBECONFIG
    kubectl get namespaces
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: "weave latest multinode"
  installerSpec:
    kubernetes:
      version: "1.30.x"
    weave:
      version: "latest"
    containerd:
      version: "latest"
    goldpinger:
      version: "latest"
  numPrimaryNodes: 1
  numSecondaryNodes: 2
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: "flannel latest multinode"
  installerSpec:
    kubernetes:
      version: "1.30.x"
    flannel:
      version: "latest"
    containerd:
      version: "latest"
    goldpinger:
      version: "latest"
  numPrimaryNodes: 1
  numSecondaryNodes: 2
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: k8s121x_openebs_containerd
  installerSpec:
    kubernetes:
      version: "1.21.x"
    weave:
      version: "2.6.x"
    contour:
      version: "1.21.x"
    containerd:
      version: "latest"
    velero:
      version: "1.8.x"
    kotsadm:
      version: "1.71.x"
    minio:
      version: "2020-01-25T02-50-51Z"
    ekco:
      version: latest
    openebs:
      version: "3.10.x"
      isLocalPVEnabled: true
      localPVStorageClassName: default
    registry:
      version: "2.7.x"
    certManager:
      version: "1.0.x"
    prometheus:
      version: "0.53.x"
    metricsServer:
      version: "0.4.x"
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: rook-upgrade-to-1.5
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: "latest"
    flannel:
      version: latest
    rook:
      version: "1.0.4"
    ekco:
      version: "latest"
    prometheus:
      version: "latest"
    minio:
      version: "latest"
  upgradeSpec:
    kubernetes:
      version: 1.20.x
    containerd:
      version: "latest"
    flannel:
      version: latest
    rook:
      version: "1.5.12"
    ekco:
      version: "latest"
    prometheus:
      version: "latest"
    minio:
      version: "latest"
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rook_ceph_object_store_info
    validate_read_write_object_store rwtest testfile.txt

    minio_object_store_info
    validate_read_write_object_store rwtest minio.txt
    echo "Checking kubectl with kube/config"
    echo "Kubeconfig was $KUBECONFIG"
    unset KUBECONFIG
    kubectl get namespaces
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rook_ceph_object_store_info
    validate_testfile rwtest testfile.txt
    validate_read_write_object_store postupgrade upgradefile.txt

    minio_object_store_info
    validate_testfile rwtest minio.txt
    validate_read_write_object_store postupgrade minioupgrade.txt

    operatorVersion=$(kubectl get deployment -n rook-ceph rook-ceph-operator -o jsonpath='{.spec.template.spec.containers[0].image}')
    echo $operatorVersion | grep 1.5.12

    k8sVersion=$(kubectl get nodes -o jsonpath='{.items[0].status.nodeInfo.kubeletVersion}')
    echo $k8sVersion | grep 1.20
    echo "Checking kubectl with kube/config"
    echo "Kubeconfig was $KUBECONFIG"
    unset KUBECONFIG
    kubectl get namespaces
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: rook-upgrade-to-1.5-airgap
  flags: "yes"
  airgap: true
  installerSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: "latest"
    flannel:
      version: latest
    rook:
      version: "1.0.4"
    ekco:
      version: "latest"
    prometheus:
      version: "latest"
    minio:
      version: "latest"
  upgradeSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: "latest"
    flannel:
      version: latest
    rook:
      version: "1.5.12"
    ekco:
      version: "latest"
    prometheus:
      version: "latest"
    minio:
      version: "latest"
  preInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rhel_9_install_host_packages lvm2 conntrack-tools socat container-selinux git

    # download the file that the airgap upgrade requires, and place it in the correct location
    curl -LO https://s3-staging.kurl.sh/staging/rookupgrade-10to14.tar.gz
    curl -LO https://s3-staging.kurl.sh/staging/rook-1.4.9.tar.gz
    curl -LO https://s3-staging.kurl.sh/staging/rook-1.5.12.tar.gz
    mkdir -p /var/lib/kurl/assets
    mv rookupgrade-10to14.tar.gz /var/lib/kurl/assets
    mv rook-1.4.9.tar.gz /var/lib/kurl/assets
    mv rook-1.5.12.tar.gz /var/lib/kurl/assets
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rook_ceph_object_store_info
    validate_read_write_object_store rwtest testfile.txt

    minio_object_store_info
    validate_read_write_object_store rwtest minio.txt
    echo "Checking kubectl with kube/config"
    echo "Kubeconfig was $KUBECONFIG"
    unset KUBECONFIG
    kubectl get namespaces
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rook_ceph_object_store_info
    validate_testfile rwtest testfile.txt
    validate_read_write_object_store postupgrade upgradefile.txt

    minio_object_store_info
    validate_testfile rwtest minio.txt
    validate_read_write_object_store postupgrade minioupgrade.txt

    operatorVersion=$(kubectl get deployment -n rook-ceph rook-ceph-operator -o jsonpath='{.spec.template.spec.containers[0].image}')
    echo $operatorVersion | grep 1.5.12

    k8sVersion=$(kubectl get nodes -o jsonpath='{.items[0].status.nodeInfo.kubeletVersion}')
    echo $k8sVersion | grep 1.19
    echo "Checking kubectl with kube/config"
    echo "Kubeconfig was $KUBECONFIG"
    unset KUBECONFIG
    kubectl get namespaces
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: "k8s_125x containerd 1.5.x upgrade to latest"
  installerSpec:
    kubernetes:
      version: 1.25.x
    flannel:
      version: latest
    containerd:
      version: 1.5.x
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.25.x
    flannel:
      version: latest
    containerd:
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_read_write_object_store rwtest testfile.txt
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_testfile rwtest testfile.txt
    validate_read_write_object_store postupgrade upgradefile.txt
  unsupportedOSIDs:
  - rocky-91 # con:
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
  - ubuntu-2204 # containerd is not supported by ubuntu 22.04
- name: "containerd upgrade from 1.2.x to 1.4.x"
  installerSpec:
    kubernetes:
      version: 1.25.x
    flannel:
      version: latest
    containerd:
      version: 1.2.x
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.25.x
    flannel:
      version: latest
    containerd:
      version: 1.4.x
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
  unsupportedOSIDs:
  - rocky-91 # con:
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
  - ubuntu-2204 # containerd is not supported by ubuntu 22.04
  - centos-74 # containerd 1.2.x does not install on centos-7
  - centos-79 # containerd 1.2.x does not install on centos-7
  - ol-79 # containerd 1.2.x does not install on oracle-linux-7
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_read_write_object_store rwtest testfile.txt
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_testfile rwtest testfile.txt
    validate_read_write_object_store postupgrade upgradefile.txt
- name: "containerd upgrade from 1.3.x to 1.5.x"
  installerSpec:
    kubernetes:
      version: 1.25.x
    flannel:
      version: latest
    containerd:
      version: 1.3.x
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.25.x
    flannel:
      version: latest
    containerd:
      version: 1.5.x
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
  unsupportedOSIDs:
  - rocky-91 # con:
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
  - ubuntu-2204 # containerd is not supported by ubuntu 22.04
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_read_write_object_store rwtest testfile.txt
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_testfile rwtest testfile.txt
    validate_read_write_object_store postupgrade upgradefile.txt
- name: "containerd upgrade from 1.4.x to 1.6.x"
  installerSpec:
    kubernetes:
      version: 1.25.x
    flannel:
      version: latest
    containerd:
      version: 1.4.x
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.25.x
    flannel:
      version: latest
    containerd:
      version: 1.6.x
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
  unsupportedOSIDs:
  - rocky-91 # con:
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
  - ubuntu-2204 # containerd is not supported by ubuntu 22.04
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_read_write_object_store rwtest testfile.txt
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_testfile rwtest testfile.txt
    validate_read_write_object_store postupgrade upgradefile.txt
- name: "containerd upgrade from 1.4.x to 1.6.x (kubernetes 1.24.x to 1.30.x)"
  installerSpec:
    kubernetes:
      version: 1.24.x
    flannel:
      version: latest
    containerd:
      version: 1.4.x
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.30.x
    flannel:
      version: latest
    containerd:
      version: 1.6.x
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
  unsupportedOSIDs:
  - rocky-91 # con:
  - rocky-9 # containerd < 1.6 is not supported on rhel 9 variants
  - ubuntu-2204 # containerd is not supported by ubuntu 22.04
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_read_write_object_store rwtest testfile.txt
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_testfile rwtest testfile.txt
    validate_read_write_object_store postupgrade upgradefile.txt
- name: custom-kurl-install-directory
  installerSpec:
    kubernetes:
      version: 1.30.x
    containerd:
      version: latest
    flannel:
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: local
    ekco:
      version: latest
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
  flags: "kurl-install-directory=/custom"
  preInstallScript: |
    touch /var/lib/kurl
    mkdir -p /custom
- name: "Upgrade Kubernetes from 1.19 to 1.30"
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: latest
    flannel:
      version: latest
    ekco:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.30.x
    containerd:
      version: latest
    flannel:
      version: latest
    ekco:
      version: latest
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh

    k8sVersion=$(kubectl get nodes -o jsonpath='{.items[0].status.nodeInfo.kubeletVersion}')
    echo $k8sVersion | grep 1.30
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: "Upgrade Kubernetes from 1.19 to 1.24, Rook from 1.0.4 to 1.5.12"
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: latest
    flannel:
      version: latest
    ekco:
      version: latest
    rook:
      version: "1.0.4"
  upgradeSpec:
    kubernetes:
      version: 1.24.x
    containerd:
      version: latest
    flannel:
      version: latest
    ekco:
      version: latest
    rook:
      version: "1.5.12"
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rook_ceph_object_store_info
    validate_read_write_object_store rwtest testfile.txt
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rook_ceph_object_store_info
    validate_testfile rwtest testfile.txt
    validate_read_write_object_store postupgrade upgradefile.txt

    k8sVersion=$(kubectl get nodes -o jsonpath='{.items[0].status.nodeInfo.kubeletVersion}')
    echo $k8sVersion | grep 1.24

    operatorVersion=$(kubectl get deployment -n rook-ceph rook-ceph-operator -o jsonpath='{.spec.template.spec.containers[0].image}')
    echo $operatorVersion | grep 1.5.12
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: "Preserve CoreDNS config, kubeadm upgrade --ignore-preflight-errors=CoreDNSUnsupportedPlugins"
  flags: "yes kubernetes-upgrade-ignore-preflight-errors=CoreDNSUnsupportedPlugins"
  installerSpec:
    kubernetes:
      version: 1.26.x
    containerd:
      version: 1.6.19
    flannel:
      version: latest
    ekco:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.30.x
    containerd:
      version: latest
    flannel:
      version: latest
    ekco:
      version: latest
  # add a customization to the coredns configmap
  # kubeadm upgrade will warn with CoreDNSUnsupportedPlugins
  postInstallScript: |
    kubectl -n kube-system get configmap coredns -o yaml | \
      sed '/prometheus.*/a \ \ \ \ \ \ \ \ rewrite {\n\ \ \ \ \ \ \ \ \ \ \ name regex blah\\.com\\.$ blah.io\n\ \ \ \ \ \ \ \ \ \ \ answer name blah\\.io\\. blah.com\n\ \ \ \ \ \ \ \ }' | \
      sed -E '/ (uid|resourceVersion|creationTimestamp): /d' | \
      kubectl replace -f -
    kubectl -n kube-system rollout restart deployment/coredns
  # read the coredns configmap and make sure the comment is still there
  postUpgradeScript: |
    kubectl -n kube-system get configmap coredns -o yaml | grep -F 'blah.io'
- name: "CoreDNS preserve kurl.nameserver"
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.26.x
    containerd:
      version: 1.6.19
    flannel:
      version: latest
    ekco:
      version: latest
    kurl:
      nameserver: 8.8.8.8
  upgradeSpec:
    kubernetes:
      version: 1.30.x
    containerd:
      version: latest
    flannel:
      version: latest
    ekco:
      version: latest
    kurl:
      nameserver: 8.8.8.8
  postInstallScript: |
    kubectl -n kube-system get configmap coredns -o yaml | grep -F 'forward . 8.8.8.8'
  postUpgradeScript: |
    kubectl -n kube-system get configmap coredns -o yaml | grep -F 'forward . 8.8.8.8'
- name: k8s130-rook-override-node-storage
  installerSpec:
    kubernetes:
      version: 1.30.x
    containerd:
      version: latest
    flannel:
      version: latest
    rook:
      version: 1.12.x
    registry:
      version: latest
    kotsadm:
      version: latest
    ekco:
      version: latest
  preInstallScript: |
    mkdir -p /opt/kurl-testgrid/
    echo "apiVersion: cluster.kurl.sh/v1beta1
    kind: Installer
    metadata:
      name: patch
    spec:
      rook:
        nodes: |
          - name: \"$(hostname | tr '[:upper:]' '[:lower:]')\"
            devices:
            - name: vdb
          - name: some-other-node
            devices:
            - name: vdb" > /opt/kurl-testgrid/patchfile.yaml
  postInstallScript: |
    # validate that our custom config is applied
    kubectl -n rook-ceph get cephcluster -oyaml | grep some-other-node

    source /opt/kurl-testgrid/testhelpers.sh
    rook_ceph_object_store_info
    validate_read_write_object_store rwtest testfile.txt
  unsupportedOSIDs:
  - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
  - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: "1.30 with all metrics and kots"
  flags: "yes"
  installerSpec:
    kubernetes:
      version: "1.30.x"
    flannel:
      version: "latest"
    contour:
      version: "latest"
    prometheus:
      version: "latest"
    registry:
      version: "latest"
    containerd:
      version: "latest"
    ekco:
      version: "latest"
    minio:
      version: "latest"
    openebs:
      version: "latest"
      isLocalPVEnabled: true
      localPVStorageClassName: "local"
    collectd:
      version: "latest"
    metricsServer:
      version: "latest"
    goldpinger:
      version: "latest"
    kotsadm:
      version: "latest"
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: (k8s 1.30) install addons not deprecated less prometheus, goldpinger
  flags: "yes"
  installerSpec:
    kubernetes:
      version: "1.30.x"
    flannel:
      version: "latest"
    rook:
      version: "1.12.x"
      isSharedFilesystemDisabled: true
    contour:
      version: "latest"
    registry:
      version: "latest"
    containerd:
      version: "latest"
    velero:
      version: "latest"
    ekco:
      version: "latest"
    minio:
      version: "latest"
    fluentd:
      version: "latest"
    openebs:
      version: "latest"
      isLocalPVEnabled: true
      localPVStorageClassName: "local"
    metricsServer:
      version: "latest"
    sonobuoy:
      version: "latest"
    collectd:
      version: "latest"
    kotsadm:
      version: "latest"
  unsupportedOSIDs:
    - centos-74 # Rook 1.11.6 will not be installed due to failed preflight checks.
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: (k8s 1.30) install addons not deprecated less prometheus, goldpinger with symbolic links
  flags: "yes"
  installerSpec:
    kubernetes:
      version: "1.30.x"
    flannel:
      version: "latest"
    rook:
      version: "1.12.x"
      isSharedFilesystemDisabled: true
    contour:
      version: "latest"
    registry:
      version: "latest"
    containerd:
      version: "latest"
    velero:
      version: "latest"
    ekco:
      version: "latest"
    minio:
      version: "latest"
    fluentd:
      version: "latest"
    openebs:
      version: "latest"
      isLocalPVEnabled: true
      localPVStorageClassName: "local"
    metricsServer:
      version: "latest"
    sonobuoy:
      version: "latest"
    collectd:
      version: "latest"
    kotsadm:
      version: "latest"
  unsupportedOSIDs:
    - centos-74 # Rook 1.11.6 will not be installed due to failed preflight checks.
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
  preInstallScript: |
    FOLDER=/testsymbolic
    
    # create directories
    mkdir -p $FOLDER/opt/cni
    mkdir -p $FOLDER/opt/containerd
    mkdir -p $FOLDER/opt/ekco
    mkdir -p $FOLDER/opt/replicated
    mkdir -p $FOLDER/mnt/drivers
    mkdir -p $FOLDER/mnt/tmpfs
    mkdir -p $FOLDER/var/lib/cni
    mkdir -p $FOLDER/var/lib/containerd
    mkdir -p $FOLDER/var/lib/containers
    mkdir -p $FOLDER/var/lib/docker
    mkdir -p $FOLDER/var/lib/dockershim
    mkdir -p $FOLDER/var/lib/etcd
    mkdir -p $FOLDER/var/lib/kubelet
    mkdir -p $FOLDER/var/lib/kurl
    mkdir -p $FOLDER/var/lib/rook
    
    # create soft links
    ln -s $FOLDER/opt/cni /opt/cni
    ln -s $FOLDER/opt/containerd /opt/containerd
    ln -s $FOLDER/opt/ekco /opt/ekco
    ln -s $FOLDER/opt/replicated /opt/replicated
    ln -s $FOLDER/mnt/drivers /mnt/drivers
    ln -s $FOLDER/mnt/tmpfs /mnt/tmpfs
    ln -s $FOLDER/var/lib/cni /var/lib/cni
    ln -s $FOLDER/var/lib/containerd /var/lib/containerd
    ln -s $FOLDER/var/lib/containers /var/lib/containers
    ln -s $FOLDER/var/lib/docker /var/lib/docker
    ln -s $FOLDER/var/lib/dockershim /var/lib/dockershim
    ln -s $FOLDER/var/lib/etcd /var/lib/etcd
    ln -s $FOLDER/var/lib/kubelet /var/lib/kubelet
    ln -s $FOLDER/var/lib/kurl /var/lib/kurl
    ln -s $FOLDER/var/lib/rook /var/lib/rook
    
    cd /testsymbolic
- name: "K8s 1.30x Airgap with invalid proxyAddress"
  cpu: 6
  airgap: true
  numPrimaryNodes: 1
  numSecondaryNodes: 2
  installerSpec:
    kurl:
      proxyAddress: http://10.128.0.70:3128
      additionalNoProxyAddresses:
        - .corporate.internal
      noProxy: false
    kubernetes:
      version: 1.30.x
    containerd:
      version: latest
    flannel:
      version: latest
    contour:
      version: latest
    registry:
      version: latest
    kotsadm:
      version: latest
    velero:
      version: latest
    ekco:
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: longhorn
  installerSpec:
    contour:
      version: latest
    kurl:
      installerVersion: ""
    containerd:
      version: latest
    ekco:
      version: latest
    kubernetes:
      version: 1.24.x
      containerLogMaxSize: "5Mi"
      containerLogMaxFiles: 5
    prometheus:
      version: latest
    registry:
      version: latest
    longhorn:
      version: latest
    flannel:
      version: latest
    minio:
      version: latest
    kotsadm:
      version: latest
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: k8s122
  installerSpec:
    kubernetes:
      version: 1.22.x
    kurl:
      installerVersion: ""
    containerd:
      version: latest
    flannel:
      version: latest
    contour:
      version: latest
    rook:
      version: 1.12.x
      isSharedFilesystemDisabled: true
    registry:
      version: latest
    kotsadm:
      version: latest
    velero:
      version: latest
    ekco:
      version: latest
  unsupportedOSIDs:
    - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: k8s122-airgap
  installerSpec:
    kubernetes:
      version: 1.22.x
    kurl:
      installerVersion: ""
    containerd:
      version: 1.6.x
    flannel:
      version: latest
    contour:
      version: latest
    rook:
      version: 1.12.x
      isSharedFilesystemDisabled: true
    registry:
      version: latest
    kotsadm:
      version: latest
    velero:
      version: latest
    ekco:
      version: latest
  airgap: true
  unsupportedOSIDs:
    - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
  preInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rhel_9_install_host_packages lvm2 conntrack-tools socat container-selinux git
- name: minimal-124
  installerSpec:
    containerd:
      version: latest
    kurl:
      installerVersion: ""
    kubernetes:
      version: 1.24.x
    flannel:
      version: latest
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: minimal-125
  installerSpec:
    containerd:
      version: latest
    kurl:
      installerVersion: ""
    kubernetes:
      version: 1.25.x
    flannel:
      version: latest
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: minimal-126
  installerSpec:
    containerd:
      version: latest
    kurl:
      installerVersion: ""
    kubernetes:
      version: 1.26.x
    flannel:
      version: latest
    ekco:
      version: latest
      enableInternalLoadBalancer: true
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: minimal-127
  installerSpec:
    containerd:
      version: latest
    kurl:
      installerVersion: ""
    kubernetes:
      version: 1.27.x
    flannel:
      version: latest
    ekco:
      version: latest
      enableInternalLoadBalancer: true
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: minimal-128
  installerSpec:
    containerd:
      version: latest
    kurl:
      installerVersion: ""
    kubernetes:
      version: 1.28.x
    flannel:
      version: latest
    ekco:
      version: latest
      enableInternalLoadBalancer: true
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: minimal-129
  installerSpec:
    containerd:
      version: latest
    kurl:
      installerVersion: ""
    kubernetes:
      version: 1.29.x
    flannel:
      version: latest
    ekco:
      version: latest
      enableInternalLoadBalancer: true
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: minimal-130
  installerSpec:
    containerd:
      version: latest
    kurl:
      installerVersion: ""
    kubernetes:
      version: 1.30.x
    flannel:
      version: latest
    ekco:
      version: latest
      enableInternalLoadBalancer: true
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: k8s124x_cis_benchmarks_checks
  installerSpec:
    kubernetes:
      version: "1.24.x"
      cisCompliance: true
    kurl:
      installerVersion: ""
    containerd:
      version: "latest"
    flannel:
      version: latest
    ekco:
      version: "latest"
  postInstallScript: |
    echo "running CIS Kubernetes Benchmark Checks"
    curl -L https://github.com/aquasecurity/kube-bench/releases/download/v0.7.0/kube-bench_0.7.0_linux_amd64.tar.gz | tar -xz
    ./kube-bench --config-dir=`pwd`/cfg --config=`pwd`/cfg/config.yaml --exit-code=1
    echo "Checking kubectl with kube/config"
    echo "Kubeconfig was $KUBECONFIG"
    unset KUBECONFIG
    kubectl get namespaces
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: k8s130x_reserved_resources
  installerSpec:
    kubernetes:
      version: "1.30.x"
      kubeReserved: true
      evictionThresholdResources: '{"memory.available":  "234Mi", "nodefs.available": "11%", "nodefs.inodesFree": "6%"}'
      systemReservedResources: '{ "cpu": "123m", "memory": "123Mi", "ephemeral-storage": "1.23Gi" }'
    kurl:
      installerVersion: ""
    containerd:
      version: "latest"
    flannel:
      version: latest
  postInstallScript: |
    set -eo pipefail
    echo "validating kubelet config contains reserved resources"
    sudo cat /var/lib/kubelet/config.yaml | grep -A 4 kubeReserved
    sudo cat /var/lib/kubelet/config.yaml | grep "ephemeral-storage: 1Gi"
    sudo cat /var/lib/kubelet/config.yaml | grep -A 4 evictionHard
    sudo cat /var/lib/kubelet/config.yaml | grep "memory.available: 234Mi"
    sudo cat /var/lib/kubelet/config.yaml | grep -A 4 systemReserved
    sudo cat /var/lib/kubelet/config.yaml | grep "cpu: 123m"
    sudo cat /var/lib/kubelet/config.yaml | grep "ephemeral-storage: 1.23Gi"
    sudo cat /var/lib/kubelet/config.yaml | grep "memory: 123Mi"
    echo "Checking kubectl with kube/config"
    echo "Kubeconfig was $KUBECONFIG"
    unset KUBECONFIG
    kubectl get namespaces
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: k8s130-openebs
  installerSpec:
    kubernetes:
      version: 1.30.x
    kurl:
      installerVersion: ""
    containerd:
      version: latest
    flannel:
      version: latest
    contour:
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
    registry:
      version: latest
    kotsadm:
      version: latest
    velero:
      version: latest
    ekco:
      version: latest
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: k8s124-airgap-rook
  installerSpec:
    kubernetes:
      version: 1.24.x
    kurl:
      installerVersion: ""
    containerd:
      version: latest
    flannel:
      version: latest
    contour:
      version: latest
    rook:
      version: 1.12.x
      isSharedFilesystemDisabled: true
    registry:
      version: latest
    kotsadm:
      version: latest
    velero:
      version: latest
    ekco:
      version: latest
  airgap: true
  unsupportedOSIDs:
    - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
  preInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rhel_9_install_host_packages lvm2 conntrack-tools socat container-selinux git
- name: "k8s_130x airgap"
  airgap: true
  installerSpec:
    kubernetes:
      version: 1.30.x
    kurl:
      installerVersion: ""
    flannel:
      version: latest
    containerd:
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    prometheus:
      version: latest
    minio:
      version: latest
    kotsadm:
      version: latest
  preInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rhel_9_install_host_packages lvm2 conntrack-tools socat container-selinux git
- name: "Migrate from Docker to Containerd and Kubernetes from 1.23 to 1.26 airgap"
  flags: "yes"
  installerApiEndpoint: https://kurl.sh
  installerSpec:
    kurl:
      installerVersion: "v2024.07.02-0"
    kubernetes:
      version: 1.23.x
    weave: # flannel has errors with dns and docker
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
    ekco:
      version: latest
    registry:
      version: latest
    kotsadm:
      version: latest
    docker:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.26.x
    weave: # flannel has errors with dns and docker
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    minio:
      version: latest
    ekco:
      version: latest
    registry:
      version: latest
    kotsadm:
      version: latest
    containerd:
      version: latest
  airgap: true
  preInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    mkdir -p /var/lib/kurl/assets
    ( cd /var/lib/kurl/assets && curl -fLO "$(kubernetes_upgrade_bundle_url "$KURL_URL" "$KURL_UPGRADE_URL")" )
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_read_write_object_store rwtest testfile.txt
    echo "Checking kubectl with kube/config"
    echo "Kubeconfig was $KUBECONFIG"
    unset KUBECONFIG
    kubectl get namespaces
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_testfile rwtest testfile.txt
    validate_read_write_object_store postupgrade upgradefile.txt
  unsupportedOSIDs:
    - rocky-91 # docker is not supported on rhel 9 variants
    - rocky-9 # docker is not supported on rhel 9 variants
- name: "weave to flannel single node with addons and openebs"
  flags: "yes"
  cpu: 8
  installerSpec:
    kubernetes:
      version: "1.26.x"
    containerd:
      version: "latest"
    weave:
      version: "latest"
    contour:
      version: "latest"
    prometheus:
      version: "latest"
    registry:
      version: "latest"
    ekco:
      version: "latest"
    minio:
      version: "2023-05-18T00-05-36Z"
    openebs:
      version: "latest"
      isLocalPVEnabled: true
      localPVStorageClassName: "local"
    rook:
      version: "1.12.x"
  upgradeSpec:
    kubernetes:
      version: "1.26.x"
    containerd:
      version: "latest"
    flannel:
      version: "latest"
    contour:
      version: "latest"
    prometheus:
      version: "latest"
    registry:
      version: "latest"
    ekco:
      version: "latest"
    minio:
      version: "2023-05-18T00-05-36Z"
    openebs:
      version: "latest"
      isLocalPVEnabled: true
      localPVStorageClassName: "local"
    rook:
      version: "1.12.x"
  unsupportedOSIDs:
    - centos-74 # Rook 1.11.6 will not be installed due to failed preflight checks.
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: "k8s_130x with kurl in-cluster support bundle spec"
  installerSpec:
    kubernetes:
      version: "1.30.x"
    containerd:
      version: latest
    flannel:
      version: latest
  postInstallScript: |
    echo "test whether the kurl support bundle spec was installed"
    supportBundle=$(kubectl get secrets -n kurl kurl-supportbundle-spec -ojsonpath='{.data.support-bundle-spec}')
    echo "$supportBundle"
    echo "test if the content of the secret is a support bundle spec"
    echo $supportBundle | base64 -d | grep 'kind: SupportBundle'
    echo "test if the support bundle has 'troubleshoot.io/kind: support-bundle' label"
    kubectl get secrets -n kurl kurl-supportbundle-spec -oyaml | grep 'troubleshoot.io/kind: support-bundle'
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
- name: merge-installer-hostpreflight-and-upgrade
  installerSpec:
    kubernetes:
      version: 1.30.x
    containerd:
      version: latest
    flannel:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.30.x
    containerd:
      version: latest
    flannel:
      version: latest
  preInstallScript: |
    mkdir -p /opt/kurl-testgrid/
    echo "apiVersion: cluster.kurl.sh/v1beta1
    kind: Installer
    metadata:
      name: installer
    spec:
      kurl:
        hostPreflights:
          apiVersion: troubleshoot.sh/v1beta2
          kind: HostPreflight
          spec:
            collectors:
            - http:
                collectorName: Can Access Replicated API
                get:
                  url: https://replicated.app
            analyzers:
            - http:
                checkName: Can Access Replicated API
                collectorName: Can Access Replicated API
                outcomes:
                - warn:
                    when: \"error\"
                    message: Error connecting to https://replicated.app
                - pass:
                    when: \"statusCode == 200\"
                    message: Connected to https://replicated.app
                - warn:
                    message: \"Unexpected response\"" > /opt/kurl-testgrid/patchfile.yaml
  postInstallScript: |
    kubectl get installer -A -o yaml | grep replicated.app
    mkdir -p /opt/kurl-testgrid/
    echo "apiVersion: cluster.kurl.sh/v1beta1
    kind: Installer
    metadata:
      name: installer
    spec:
      kurl:
        hostPreflights:
          apiVersion: troubleshoot.sh/v1beta2
          kind: HostPreflight
          spec:
            collectors:
            - tcpPortStatus:
                collectorName: \"Checks port 8888 is available\"
                port: 8888
            analyzers:
            - tcpPortStatus:
                checkName: \"Checks port 8888 is available\"
                collectorName: \"Checks port 8888 is available\"
                outcomes:
                  - fail:
                      when: \"connection-refused\"
                      message: Connection to port 8888 was refused.
                  - warn:
                      when: \"address-in-use\"
                      message: Another process was already listening on port 8888.
                  - fail:
                      when: \"connection-timeout\"
                      message: Timed out connecting to port 8888.
                  - fail:
                      when: \"error\"
                      message: Unexpected port status
                  - pass:
                      when: \"connected\"
                      message: Port 8888 is available
                  - warn:
                      message: Unexpected port status" > /opt/kurl-testgrid/patchfile.yaml
  postUpgradeScript: |
    kubectl get installer -A -o yaml | grep 8888
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8

- name: reset and reinstall
  installerSpec:
    kubernetes:
      version: 1.30.x
    containerd:
      version: latest
    flannel:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.27.x # this is a LOWER version than the installer to ensure that the reset worked
    containerd:
      version: latest
    flannel:
      version: latest
  postInstallScript: |
    echo "export FORCE_RESET=1" > tasks2.sh
    cat tasks.sh >> tasks2.sh
    cat tasks2.sh | sudo bash -s reset
  postUpgradeScript: |
    k8sVersion=$(kubectl get nodes -o jsonpath='{.items[0].status.nodeInfo.kubeletVersion}')
    echo $k8sVersion | grep 1.27
  unsupportedOSIDs:
    - centos-81 # containerd 1.6.31+ not supported on non-stream centos 8
