- name: Migrate from Rook 1.0.4 to OpenEBS + Minio
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    rook:
      version: 1.0.4
  upgradeSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
    minio:
      version: latest
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_deployment_with_mounted_volume "migration-test" "default" "/data" "registry:2.8.1"
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    test_push_image_to_registry
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    test_pull_image_from_registry
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/rook-ceph ; then
      echo Rook namespace found after the upgrade.
      exit 1
    fi
    if [ -d "/var/lib/rook" ] || [ -d "/opt/replicated/rook" ]; then
       echo  Rook Data directories not removed.
       exit 1
    fi
- name: Migrate from Rook 1.10.x to OpenEBS + Minio
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.26.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    rook:
      version: 1.10.x
  upgradeSpec:
    kubernetes:
      version: 1.26.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
    minio:
      version: latest
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_deployment_with_mounted_volume "migration-test" "default" "/data" "registry:2.8.1"
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    test_push_image_to_registry
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    test_pull_image_from_registry
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/rook-ceph ; then
      echo Rook namespace found after the upgrade.
      exit 1
    fi
    if [ -d "/var/lib/rook" ] || [ -d "/opt/replicated/rook" ]; then
       echo  Rook Data directories not removed.
       exit 1
    fi
- name: Migrate from Longhorn (S3 disabled) to OpenEBS + Minio
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.24.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    kotsadm:
      version: latest
      disableS3: true
    ekco:
      version: latest
    longhorn:
      version: 1.3.x
  upgradeSpec:
    kubernetes:
      version: 1.24.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    kotsadm:
      version: latest
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
    minio:
      version: latest
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_deployment_with_mounted_volume "migration-test" "default" "/data" "registry:2.8.1"
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/longhorn-system ; then
      echo Longhorn namespace found after the upgrade.
      exit 1
    fi
- name: Migrate from Longhorn + Minio to OpenEBS + Minio
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.24.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    longhorn:
      version: 1.3.x
    minio:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.24.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
    minio:
      version: latest
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_deployment_with_mounted_volume "migration-test" "default" "/data" "registry:2.8.1"
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    test_push_image_to_registry
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    test_pull_image_from_registry
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/longhorn-system ; then
      echo Longhorn namespace found after the upgrade.
      exit 1
    fi
- name: Migrate from Rook 1.0.4 to OpenEBS (S3 disabled)
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    kotsadm:
      version: latest
    ekco:
      version: latest
    rook:
      version: 1.0.4
  upgradeSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    kotsadm:
      version: latest
      disableS3: true
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    test_pull_image_from_registry
    check_and_customize_kurl_integration_test_application
    if ! kubectl get namespace/rook-ceph ; then
      echo Rook namespace should NOT be removed after the upgrade. MinIO is NOT selected
      exit 1
    fi
    if [ -d "/var/lib/rook" ] || [ -d "/opt/replicated/rook" ]; then
       echo  Rook Data directories not removed.
       exit 1
    fi
- name: Migrate from Rook 1.10.x to OpenEBS (S3 disabled)
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.26.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    kotsadm:
      version: latest
    ekco:
      version: latest
    rook:
      version: 1.10.x
  upgradeSpec:
    kubernetes:
      version: 1.26.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    kotsadm:
      version: latest
      disableS3: true
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    check_and_customize_kurl_integration_test_application
    if ! kubectl get namespace/rook-ceph ; then
      echo Rook namespace should NOT be removed after the upgrade. MinIO is NOT selected
      exit 1
    fi
    if [ -d "/var/lib/rook" ] || [ -d "/opt/replicated/rook" ]; then
       echo  Rook Data directories not removed.
       exit 1
    fi
- name: Migrate from Longhorn (S3 disabled) to OpenEBS (S3 disabled)
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.24.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    kotsadm:
      version: latest
      disableS3: true
    ekco:
      version: latest
    longhorn:
      version: 1.3.x
  upgradeSpec:
    kubernetes:
      version: 1.24.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    kotsadm:
      version: latest
      disableS3: true
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/longhorn-system ; then
      echo Longhorn namespace found after the upgrade.
      exit 1
    fi
- name: Migrate from Longhorn + Minio to OpenEBS (S3 disabled)
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.24.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    kotsadm:
      version: latest
    ekco:
      version: latest
    longhorn:
      version: 1.3.x
    minio:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.24.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    kotsadm:
      version: latest
      disableS3: true
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/longhorn-system ; then
      echo Longhorn namespace found after the upgrade.
      exit 1
    fi
- name: Migrate from OpenEBS + Minio to OpenEBS (S3 disabled)
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.26.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    kotsadm:
      version: latest
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
    minio:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.26.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    kotsadm:
      version: latest
      disableS3: true
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    check_and_customize_kurl_integration_test_application
- name: Migrate from Rook 1.0.4 to Rook 1.10.x
  flags: "yes"
  cpu: 6
  numPrimaryNodes: 1
  numSecondaryNodes: 2
  installerSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    rook:
      version: 1.0.4
  upgradeSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    rook:
      version: 1.10.x
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_deployment_with_mounted_volume "migration-test" "default" "/data" "registry:2.8.1"
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    test_push_image_to_registry
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "rook"
    test_pull_image_from_registry
    check_and_customize_kurl_integration_test_application
    if [ -d "/var/lib/rook" ] || [ -d "/opt/replicated/rook" ]; then
       echo  Rook Data directories not removed.
       exit 1
    fi
- name: Migrate from Longhorn + Minio to Rook 1.10.x
  flags: "yes"
  cpu: 6
  numPrimaryNodes: 1
  numSecondaryNodes: 2
  installerSpec:
    kubernetes:
      version: 1.21.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    longhorn:
      version: 1.3.x
    minio:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.21.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    rook:
      version: 1.10.x
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_deployment_with_mounted_volume "migration-test" "default" "/data" "registry:2.8.1"
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    test_push_image_to_registry
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "rook"
    test_pull_image_from_registry
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/longhorn-system ; then
      echo Longhorn namespace found after the upgrade.
      exit 1
    fi
- name: Migrate from Rook 1.0.4 to OpenEBS + Minio (multi-node)
  flags: "yes"
  cpu: 6
  numPrimaryNodes: 1
  numSecondaryNodes: 2
  installerSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    rook:
      version: 1.0.4
  upgradeSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
    minio:
      version: latest
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_deployment_with_mounted_volume "migration-test" "default" "/data" "registry:2.8.1"
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    test_push_image_to_registry
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    test_pull_image_from_registry
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/rook-ceph ; then
      echo Rook namespace found after the upgrade.
      exit 1
    fi
    if [ -d "/var/lib/rook" ] || [ -d "/opt/replicated/rook" ]; then
       echo  Rook Data directories not removed.
       exit 1
    fi
- name: Migrate from Rook 1.10.x to OpenEBS + Minio (multi-node)
  flags: "yes"
  cpu: 6
  numPrimaryNodes: 1
  numSecondaryNodes: 2
  installerSpec:
    kubernetes:
      version: 1.26.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    rook:
      version: 1.10.x
  upgradeSpec:
    kubernetes:
      version: 1.26.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
    minio:
      version: latest
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_deployment_with_mounted_volume "migration-test" "default" "/data" "registry:2.8.1"
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    test_push_image_to_registry
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    test_pull_image_from_registry
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/rook-ceph ; then
      echo Rook namespace found after the upgrade.
      exit 1
    fi
    if [ -d "/var/lib/rook" ] || [ -d "/opt/replicated/rook" ]; then
       echo  Rook Data directories not removed.
       exit 1
    fi
- name: Migrate from Longhorn + Minio to OpenEBS + Minio
  flags: "yes"
  cpu: 6
  numPrimaryNodes: 1
  numSecondaryNodes: 2
  installerSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    longhorn:
      version: 1.3.x
    minio:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.19.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
    minio:
      version: latest
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_deployment_with_mounted_volume "migration-test" "default" "/data" "registry:2.8.1"
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    test_push_image_to_registry
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    test_pull_image_from_registry
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/longhorn-system ; then
      echo Longhorn namespace found after the upgrade.
      exit 1
    fi
- name: Migrate from Rook 1.10.x to OpenEBS 3.4.0 with localpv migrate
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.24.x
    flannel:
      version: latest
    containerd:
      version: latest
    rook:
      version: 1.10.x
    kotsadm:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.26.x
    flannel:
      version: latest
    containerd:
      version: latest
    openebs:
      isLocalPVEnabled: true
      localPVStorageClassName: openebs
      namespace: openebs
      version: 3.4.0
    minio:
      version: latest
    kotsadm:
      version: latest
  unsupportedOSIDs:
    - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rook_ceph_object_store_info
    validate_read_write_object_store rwtest testfile.txt
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_testfile rwtest testfile.txt
    validate_read_write_object_store postupgrade upgradefile.txt
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/rook-ceph ; then
      echo Rook namespace found after the upgrade.
      exit 1
    fi
    if [ -d "/var/lib/rook" ] || [ -d "/opt/replicated/rook" ]; then
       echo  Rook Data directories not removed.
       exit 1
    fi
- name: Migrate from Rook 1.0.4 to OpenEBS + Minio (Docker config)
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.19.x
    docker:
      version: 19.03.10
      daemonConfig: |
        {
          "exec-opts": ["native.cgroupdriver=systemd"],
          "log-opts": {
            "max-size": "100m",
            "max-file": "3"
          }
        }
    weave:
      version: 2.6.5
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    rook:
      version: 1.0.4
  upgradeSpec:
    kubernetes:
      version: 1.21.x
    docker:
      version: 19.03.10
      daemonConfig: |
        {
          "exec-opts": ["native.cgroupdriver=systemd"],
          "log-opts": {
            "max-size": "100m",
            "max-file": "3"
          }
        }
    weave:
      version: 2.6.5-20221025
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
    minio:
      version: latest
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_deployment_with_mounted_volume "migration-test" "default" "/data" "registry:2.8.1"
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    test_push_image_to_registry
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    test_pull_image_from_registry
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/rook-ceph ; then
      echo Rook namespace found after the upgrade.
      exit 1
    fi
    if [ -d "/var/lib/rook" ] || [ -d "/opt/replicated/rook" ]; then
       echo  Rook Data directories not removed.
       exit 1
    fi
  unsupportedOSIDs:
    - ol-9 # docker is not supported on rhel 9 variants
    - rocky-91 # docker is not supported on rhel 9 variants
- name: Migrate from OpenEBS (S3 disabled) to OpenEBS + Minio
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.26.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
      disableS3: true
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
  upgradeSpec:
    kubernetes:
      version: 1.26.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
    minio:
      version: latest
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_deployment_with_mounted_volume "migration-test" "default" "/data" "registry:2.8.1"
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    test_push_image_to_registry
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    test_pull_image_from_registry
    check_and_customize_kurl_integration_test_application
- name: Migrate from Rook+OpenEBS to OpenEBS (Kubernetes 1.19.x to 1.21.x, Docker to Containerd)
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.19.x
    docker:
      version: 19.03.10
      daemonConfig: |
        {
          "exec-opts": ["native.cgroupdriver=systemd"],
          "log-opts": {
             "max-size": "100m",
             "max-file": "3"
          }
        }
    weave:
      version: 2.6.5
    rook:
      version: 1.0.4
    contour:
      version: 1.7.0
      tlsMinimumProtocolVersion: 1.2
    registry:
      version: 2.7.1
    prometheus:
      version: 0.49.0-17.1.3
    velero:
      version: 1.6.0
    kotsadm:
      version: 1.57.0
    goldpinger:
      version: 3.2.0-4.1.1
    openebs:
      version: 1.6.0
      namespace: openebs
      isLocalPVEnabled: true
      localPVStorageClassName: openebs
      isCstorEnabled: false
    ekco:
      version: 0.10.2
      nodeUnreachableToleration: 5m
      minReadyMasterNodeCount: 2
      minReadyWorkerNodeCount: 0
      rookShouldUseAllNodes: false
      rookShouldDisableReconcileMDSPlacement: false
      rookShouldDisableReconcileCephCSIResources: false
      shouldDisableRebootServices: false
      shouldDisableClearNodes: false
      shouldEnablePurgeNodes: false
      shouldDisableRestartFailedEnvoyPods: false
      envoyPodsNotReadyDuration: 5m
  upgradeSpec:
    kubernetes:
      version: 1.21.x
      containerLogMaxFiles: 5
      containerLogMaxSize: 5Mi
    containerd:
      version: 1.4.6
    weave:
      version: 2.6.5
    longhorn:
      version: 1.1.2
    minio:
      version: 2020-01-25T02-50-51Z
    contour:
      version: 1.7.0
    registry:
      version: 2.7.1
    prometheus:
      version: 0.49.0-17.1.3
    velero:
      version: 1.6.0
    kotsadm:
      version: 1.90.0
    goldpinger:
      version: 3.2.0-4.1.1
    openebs:
      version: 3.4.0
      namespace: openebs
      isLocalPVEnabled: true
      localPVStorageClassName: openebs
      isCstorEnabled: false
    ekco:
      version: 0.16.0
      nodeUnreachableToleration: 5m
      minReadyMasterNodeCount: 2
      minReadyWorkerNodeCount: 0
      rookShouldUseAllNodes: false
      rookShouldDisableReconcileMDSPlacement: false
      rookShouldDisableReconcileCephCSIResources: false
      shouldDisableRebootServices: false
      shouldDisableClearNodes: false
      shouldEnablePurgeNodes: false
      shouldDisableRestartFailedEnvoyPods: false
      envoyPodsNotReadyDuration: 5m
  unsupportedOSIDs:
    - ubuntu-2204 # containerd 1.4.x is not supported on ubuntu 22.04
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    minio_object_store_info
    validate_testfile rwtest testfile.txt
    validate_read_write_object_store postupgrade upgradefile.txt
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/rook-ceph ; then
      echo Rook namespace found after the upgrade.
      exit 1
    fi
    if [ -d "/var/lib/rook" ] || [ -d "/opt/replicated/rook" ]; then
       echo  Rook Data directories not removed.
       exit 1
    fi
  unsupportedOSIDs:
    - ol-9 # docker is not supported on rhel 9 variants
    - rocky-91 # docker is not supported on rhel 9 variants
