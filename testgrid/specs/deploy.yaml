- name: "Upgrade to 1.23 to 1.25, disable s3, weave to flannel, docker to containerd"
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.23.x
    weave:
      version: latest
    rook:
      version: 1.11.x
    kotsadm:
      version: latest
    docker:
      version: 20.10.x
    ekco:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.25.x
    flannel:
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: local
    kotsadm:
      version: latest
      disableS3: true
    containerd:
      version: latest
    ekco:
      version: latest
  unsupportedOSIDs:
    - centos-74 # Rook 1.8+ not supported on 3.10.0-693.el7.x86_64 kernel
    - rocky-92 # docker is not supported on rhel 9 variants
- name: "Upgrade to 1.25 to 1.27, Migrate from Rook 1.11.x to OpenEBS + Minio"
  flags: "yes"
  installerSpec:
    kubernetes:
      version: 1.25.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    rook:
      version: 1.11.x
  upgradeSpec:
    kubernetes:
      version: 1.27.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
    minio:
      version: latest
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_deployment_with_mounted_volume "migration-test" "default" "/data" "registry:2.8.1"
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    test_push_image_to_registry
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    test_pull_image_from_registry
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/rook-ceph ; then
      echo Rook namespace found after the upgrade.
      exit 1
    fi
    if [ -d "/var/lib/rook" ] || [ -d "/opt/replicated/rook" ]; then
       echo  Rook Data directories not removed.
       exit 1
    fi
- name: "Upgrade to 1.22 to 1.24, Migrate from Longhorn + Minio to OpenEBS + Minio (multi-node)"
  flags: "yes"
  cpu: 6
  numPrimaryNodes: 1
  numSecondaryNodes: 2
  installerSpec:
    kubernetes:
      version: 1.22.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    longhorn:
      version: 1.3.x
    minio:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.24.x
    containerd:
      version: 1.6.x
    flannel:
      version: 0.21.x
    registry:
      version: 2.8.1
    kotsadm:
      version: latest
    ekco:
      version: latest
    openebs:
      version: 3.4.x
      isLocalPVEnabled: true
      localPVStorageClassName: local
    minio:
      version: latest
  postInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    create_deployment_with_mounted_volume "migration-test" "default" "/data" "registry:2.8.1"
    create_random_file_and_upload_to_deployment "migration-test" "default" "./test.data" "/data/test.data"
    test_push_image_to_registry
    install_and_customize_kurl_integration_test_application
  postUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    sleep 120
    download_file_from_deployment_and_compare "migration-test" "default" "./test.data" "/data/test.data"
    pvc_uses_provisioner "migration-test" "default" "openebs"
    test_pull_image_from_registry
    check_and_customize_kurl_integration_test_application
    if kubectl get namespace/longhorn-system ; then
      echo Longhorn namespace found after the upgrade.
      exit 1
    fi
- name: "Upgrade from k8s 1.26 to 1.27 - Airgap"
  airgap: true
  installerSpec:
    kubernetes:
      version: 1.26.x
    kurl:
      installerVersion: ""
    flannel:
      version: latest
    containerd:
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    prometheus:
      version: latest
    minio:
      version: latest
    kotsadm:
      version: latest
  upgradeSpec:
    kubernetes:
      version: 1.26.x
    kurl:
      installerVersion: ""
    flannel:
      version: latest
    containerd:
      version: latest
    openebs:
      version: latest
      isLocalPVEnabled: true
      localPVStorageClassName: default
    prometheus:
      version: latest
    minio:
      version: latest
    kotsadm:
      version: latest
  preInstallScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rhel_9_install_host_packages lvm2 conntrack-tools socat container-selinux git
  preUpgradeScript: |
    source /opt/kurl-testgrid/testhelpers.sh
    rhel_9_install_host_packages lvm2 conntrack-tools socat container-selinux git
- name: k8s124x_cis_benchmarks_checks
  installerSpec:
    kubernetes:
      version: "1.24.x"
      cisCompliance: true
    containerd:
      version: "latest"
    flannel:
      version: latest
    ekco:
      version: "latest"
  postInstallScript: |
    echo "running CIS Kubernetes Benchmark Checks"
    kube_bench_version="$(curl -s https://api.github.com/repos/aquasecurity/kube-bench/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')"
    curl -L https://github.com/aquasecurity/kube-bench/releases/download/v${kube_bench_version}/kube-bench_${kube_bench_version}_linux_amd64.tar.gz | tar -xz
    ./kube-bench --config-dir=`pwd`/cfg --config=`pwd`/cfg/config.yaml --exit-code=1
    echo "Checking kubectl with kube/config"
    echo "Kubeconfig was $KUBECONFIG"
    unset KUBECONFIG
    kubectl get namespaces