# https://kurl.sh/docs/install-with-kurl/system-requirements
apiVersion: troubleshoot.sh/v1beta2
kind: Preflight
metadata:
  name: kurl-builtin-oncluster
spec:
  collectors:
    - clusterResources: {}
  hostCollectors:
    - run:
        collectorName: journalctl-kubelet
        exclude: '{{kurl or (not .IsPrimary) (not .IsUpgrade) }}'
        command: [ "journalctl" ]
        args: [ "-u", "kubelet", "--no-pager", "-S", "1 day ago" ]
  analyzers:
    - nodeResources:
        checkName: Node status check
        exclude: '{{kurl or (not .IsPrimary) (not .IsUpgrade) }}'
        outcomes:
          - fail:
              when: "nodeCondition(Ready) == False"
              message: "Not all nodes are online."
          - fail:
              when: "nodeCondition(Ready) == Unknown"
              message: "Not all nodes are online."
          - pass:
              message: "All nodes are online."
    - textAnalyze:
        checkName: "Check for CNI 'not ready' messages"
        exclude: '{{kurl or (not .IsPrimary) (not .IsUpgrade) }}'
        file: run/journalctl-kubelet/journalctl-kubelet.logs
        ignoreIfNoFiles: true
        regex: "Container runtime network not ready.*cni plugin not initialized"
        outcomes:
          - pass:
              when: "false"
              message: "CNI is initialized"
          - fail:
              when: "true"
              message: "CNI plugin not initialized: there may be a problem with the CNI configuration on the host, check /etc/cni/net.d/*.conflist against a known good configuration"
