# https://kurl.sh/docs/install-with-kurl/system-requirements
apiVersion: troubleshoot.sh/v1beta2
kind: Preflight
metadata:
  name: kurl-builtin-oncluster
spec:
  collectors:
    - clusterResources: {}
    - clusterInfo: {}
  analyzers:
    - nodeResources:
        checkName: Node status check
        exclude: '{{kurl or (not .IsPrimary) (not .IsUpgrade) }}'
        outcomes:
          - fail:
              when: "nodeCondition(Ready) == False"
              message: "Not all nodes are online."
          - fail:
              when: "nodeCondition(Ready) == Unknown"
              message: "Not all nodes are online."
          - pass:
              message: "All nodes are online."
    - clusterPodStatuses:
        checkName: Pods status check
        namespace:
          - kube-flannel
          - default
          - kube-node-lease
          - kube-public
          - kube-system
          - kurl
          - projectcontour
          - rook-ceph
          - velero
          - longhorn-system
          - openebs
        exclude: '{{kurl or (not .IsPrimary) (not .IsUpgrade) }}'
        outcomes:
          - pass:
              message: "The Pod {{ .Name }} into the namespace {{ .Namespace }} is OK."
          - warn:
              when: "!= Healthy" # Catch all unhealthy pods. A pod is considered healthy if it has a status of Completed, or Running and all of its containers are ready.
              message: "A Pod, {{ .Name }} into the namespace {{ .Namespace }}, is unhealthy with a status of: {{ .Status.Reason }}. Restarting the pod may fix the issue."
